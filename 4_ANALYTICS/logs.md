./scripts/harmonic_mean.sh
=== Обновляем куб ===
REFRESH MATERIALIZED VIEW
=== Весь куб ===
 dishtype_id | dishtype_name | cook_id |          cook_name          | harmonic_price_per_portion |                             dish_names                              
-------------+---------------+---------+-----------------------------+----------------------------+---------------------------------------------------------------------
             |               |         |                             |    43.35357021173420494577 | 
             |               |         |                             |    25.96786962078554610581 | 
             |               |      18 | Сливкина Наталья Эдуардовна |    43.30251352664913095041 | 
             |               |      19 | Ломоносов Игорь Павлович    |    53.31057199350141640576 | 
             |               |      20 | Линина Мария Семеновна      |    52.81709167163787121991 | 
             |               |      21 | Бабкина Надежда Григорьевна |    48.45118154078247239683 | 
           1 | Напитки       |         |                             |    19.07164480322906155366 | 
           1 | Напитки       |         |                             |    15.88235294117647058814 | Мин.вода "Бон аква", Мин.вода "Шишкин лес", Сок "J7" в ассортименте
           1 | Напитки       |      18 | Сливкина Наталья Эдуардовна |    23.33333333333333333217 | Компот из абрикосов, Компот из яблок
           1 | Напитки       |      21 | Бабкина Надежда Григорьевна |    25.00000000000000000000 | Компот из слив
           2 | Первое блюдо  |         |                             |    48.95909324773657495199 | 
           2 | Первое блюдо  |      18 | Сливкина Наталья Эдуардовна |    48.97959183673469388155 | Суп гороховый, Суп из морепродуктов
           2 | Первое блюдо  |      19 | Ломоносов Игорь Павлович    |    48.59154929577464788390 | Борщ, Суп куриный, Щи
           2 | Первое блюдо  |      20 | Линина Мария Семеновна      |    45.00000000000000000450 | Суп овощной
           2 | Первое блюдо  |      21 | Бабкина Надежда Григорьевна |    54.99999999999999999450 | Крем-суп из шампиньонов
           3 | Второе блюдо  |         |                             |    83.55145249702878346883 | 
           3 | Второе блюдо  |      18 | Сливкина Наталья Эдуардовна |    82.89951923076923077601 | Котлета жаренная, Стейк из семги
           3 | Второе блюдо  |      19 | Ломоносов Игорь Павлович    |   100.34262948207171317804 | Бефстроганоф, Рыба жаренная
           3 | Второе блюдо  |      20 | Линина Мария Семеновна      |    65.18518518518518518132 | Бедро куриное, Сосиски отварные
           3 | Второе блюдо  |      21 | Бабкина Надежда Григорьевна |   110.60000000000000000686 | Гуляш из говядины
           4 | Гарнир        |         |                             |    45.94254492572856597086 | 
           4 | Гарнир        |      19 | Ломоносов Игорь Павлович    |    38.85421994884910486016 | Гречневая каша, Макароны
           4 | Гарнир        |      20 | Линина Мария Семеновна      |    44.79999999999999999713 | Смесь золотистого и дикого риса
           4 | Гарнир        |      21 | Бабкина Надежда Григорьевна |    52.81502905511184228649 | Картофель по-русски, Картофельное пюре, Плов
           5 | Десерт        |         |                             |    65.11516247789005689893 | 
           5 | Десерт        |         |                             |    71.14757978971344488353 | Булочка с маком, Пирожное вишневое, Тирамиссу
           5 | Десерт        |      18 | Сливкина Наталья Эдуардовна |    55.80035650623885918442 | Пирожное "муравейник", Яблочный штрудель
           5 | Десерт        |      19 | Ломоносов Игорь Павлович    |    52.30000000000000000335 | Булочка с творогом
           5 | Десерт        |      20 | Линина Мария Семеновна      |    96.39999999999999996800 | Творожная запеканка
           6 | Салат         |         |                             |    47.53900839622835277742 | 
           6 | Салат         |      18 | Сливкина Наталья Эдуардовна |    44.43684200433390223619 | Салат морковный, Салат оливье, Сельдь под шубой
           6 | Салат         |      19 | Ломоносов Игорь Павлович    |    60.40000000000000000435 | Салат греческий
           6 | Салат         |      20 | Линина Мария Семеновна      |    47.16954810097334395911 | HM Demo Salad 1, HM Demo Salad 2, Салат "мостик", Салат крабовый
           6 | Салат         |      21 | Бабкина Надежда Григорьевна |    48.90000000000000000900 | Салат весенний
(34 rows)

=== Самый неэффективный повар ===
Чем больше harmonic_price_per_portion, тем “неэффективнее” повар: за 1 рубль получается меньше порций (в сценарии равного бюджета на позицию).
 cook_id |        cook_name         | harmonic_price_per_portion |    portions_per_rub    
---------+--------------------------+----------------------------+------------------------
      19 | Ломоносов Игорь Павлович |    53.31057199350141640576 | 0.01875800545006158378
(1 row)

=== Демоданные для куба: очистка → проверка отсутствия → вставка → refresh → проверка наличия ===
— Удаляем старые демо-строки в db1 (dishid IN 10001,10002 | name LIKE 'HM Demo%')
DELETE 2
 demo_rows_in_canteendishes 
----------------------------
                          0
(1 row)

— Обновляем куб и показываем группу (dishtype=6, cook=20) — до вставки
REFRESH MATERIALIZED VIEW
 dishtype_id | dishtype_name | cook_id |       cook_name        | harmonic_price_per_portion |           dish_names           
-------------+---------------+---------+------------------------+----------------------------+--------------------------------
           6 | Салат         |      20 | Линина Мария Семеновна |    49.37975708502024291448 | Салат "мостик", Салат крабовый
(1 row)

— Вставляем демо-блюда в db1 под (dishtype=6, cook=20)
INSERT 0 2
 demo_rows_after_insert 
------------------------
                      2
(1 row)

— Обновляем куб и показываем группу (dishtype=6, cook=20) — после вставки
REFRESH MATERIALIZED VIEW
 dishtype_id | dishtype_name | cook_id |       cook_name        | harmonic_price_per_portion |                            dish_names                            
-------------+---------------+---------+------------------------+----------------------------+------------------------------------------------------------------
           6 | Салат         |      20 | Линина Мария Семеновна |    47.16954810097334395911 | HM Demo Salad 1, HM Demo Salad 2, Салат "мостик", Салат крабовый
(1 row)

\n=== Запрос куба через db1 (FDW → db2, user=fdw_reader_db2) ===
 dishtype_id | dishtype_name | cook_id |          cook_name          | harmonic_price_per_portion 
-------------+---------------+---------+-----------------------------+----------------------------
             |               |         |                             |    25.96786962078554610581
             |               |         |                             |    43.35357021173420494577
             |               |      18 | Сливкина Наталья Эдуардовна |    43.30251352664913095041
             |               |      19 | Ломоносов Игорь Павлович    |    53.31057199350141640576
             |               |      20 | Линина Мария Семеновна      |    52.81709167163787121991
             |               |      21 | Бабкина Надежда Григорьевна |    48.45118154078247239683
           1 | Напитки       |         |                             |    15.88235294117647058814
           1 | Напитки       |         |                             |    19.07164480322906155366
           1 | Напитки       |      18 | Сливкина Наталья Эдуардовна |    23.33333333333333333217
           1 | Напитки       |      21 | Бабкина Надежда Григорьевна |    25.00000000000000000000
(10 rows)

